<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hakimi 8K Pro (Vercel Edition)</title>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; text-align: center; padding: 20px; }
        h1 { background: linear-gradient(to right, #34d399, #3b82f6); -webkit-background-clip: text; color: transparent; margin: 0; }
        
        .container { max-width: 600px; margin: auto; }
        
        /* Input Box */
        .input-group { text-align: left; margin-bottom: 20px; background: #1e293b; padding: 15px; border-radius: 8px; }
        label { font-size: 12px; color: #94a3b8; display: block; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }

        /* Upload */
        .upload-box { border: 2px dashed #334155; padding: 40px; border-radius: 12px; cursor: pointer; margin-top: 20px; }
        .upload-box:hover { border-color: #3b82f6; }

        img { max-width: 100%; border-radius: 8px; margin-top: 20px; display: none; border: 1px solid #333; }
        
        button { background: #3b82f6; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        button:disabled { background: #475569; opacity: 0.7; cursor: wait; }

        .log { margin-top: 15px; font-family: monospace; font-size: 12px; color: #fbbf24; text-align: left; background: black; padding: 10px; border-radius: 6px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>HAKIMI 8K PRO</h1>
    <p style="color:#aaa; font-size:13px;">Server-Powered AI Upscaler</p>

    <div class="input-group">
        <label>üîë Replicate API Token</label>
        <input type="text" id="apiKey" placeholder="r8_..." value="">
    </div>

    <div class="upload-box" onclick="document.getElementById('fileIn').click()">
        <span style="font-size:30px">‚òÅÔ∏è</span><br>Tap to Upload
        <input type="file" id="fileIn" hidden accept="image/*">
    </div>

    <img id="preview">

    <div class="log" id="logs"></div>

    <button id="btnProc" onclick="processImage()" style="display:none">‚ú® START 8K UPSCALE</button>

    <div id="resultArea" style="display:none; margin-top:30px;">
        <h3 style="color:#10b981">‚úÖ Done!</h3>
        <img id="finalImg">
        <button onclick="downloadImg()" style="background:#10b981">‚¨áÔ∏è DOWNLOAD</button>
    </div>
</div>

<script>
    let currentFile;

    function log(msg) {
        const l = document.getElementById('logs');
        l.style.display = 'block';
        l.innerHTML += `> ${msg}<br>`;
        l.scrollTop = l.scrollHeight;
    }

    document.getElementById('fileIn').addEventListener('change', (e) => {
        if(e.target.files[0]) {
            currentFile = e.target.files[0];
            document.getElementById('preview').src = URL.createObjectURL(currentFile);
            document.getElementById('preview').style.display = 'block';
            document.getElementById('btnProc').style.display = 'block';
        }
    });

    async function processImage() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if(!apiKey) { alert("Enter API Key"); return; }

        const btn = document.getElementById('btnProc');
        btn.disabled = true;
        log("1. Converting Image...");

        try {
            const base64 = await toBase64(currentFile);
            
            // A. START PREDICTION
            log("2. Sending to Vercel Server...");
            
            const startReq = await fetch('/api/server', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'create',
                    apiKey: apiKey,
                    image: base64
                })
            });

            const startData = await startReq.json();
            if(startData.error) throw new Error(startData.error);
            
            const getUrl = startData.urls.get;
            log("3. AI Processing (Wait ~10s)...");

            // B. POLL FOR RESULT
            let resultUrl = null;
            while(!resultUrl) {
                await new Promise(r => setTimeout(r, 2000)); // Wait 2s
                
                const checkReq = await fetch('/api/server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'check',
                        apiKey: apiKey,
                        predictionUrl: getUrl
                    })
                });
                
                const statusData = await checkReq.json();
                
                if(statusData.status === 'succeeded') {
                    resultUrl = statusData.output;
                    log("‚úÖ Success!");
                } else if(statusData.status === 'failed') {
                    throw new Error("AI Failed.");
                } else {
                    log(`   Status: ${statusData.status}...`);
                }
            }

            // Show Result
            document.getElementById('finalImg').src = resultUrl;
            document.getElementById('finalImg').style.display = 'block';
            document.getElementById('resultArea').style.display = 'block';
            btn.disabled = false;

        } catch (err) {
            alert(err.message);
            log("‚ùå Error: " + err.message);
            btn.disabled = false;
        }
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    function downloadImg() {
        const a = document.createElement('a');
        a.href = document.getElementById('finalImg').src;
        a.download = "Hakimi_8K.png";
        a.click();
    }
</script>

</body>
</html>
