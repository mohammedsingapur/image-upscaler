<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hakimi Pro Cloud Upscaler</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #0f172a; color: white; text-align: center; padding: 20px; }
        h1 { background: linear-gradient(to right, #f472b6, #a855f7); -webkit-background-clip: text; color: transparent; margin: 0; }
        p { color: #94a3b8; font-size: 13px; }

        .container { max-width: 600px; margin: auto; }
        
        /* API Key Box */
        .api-box { background: #334155; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; }
        .api-box label { font-size: 12px; color: #cbd5e1; display: block; margin-bottom: 5px; }
        .api-box input { width: 100%; padding: 10px; border-radius: 5px; border: none; background: #1e293b; color: white; box-sizing: border-box; }
        
        /* Upload Area */
        .upload-box {
            border: 2px dashed #475569; background: #1e293b; padding: 40px;
            border-radius: 12px; cursor: pointer; transition: 0.2s;
        }
        .upload-box:hover { border-color: #a855f7; }
        
        img { max-width: 100%; border-radius: 8px; margin-top: 15px; display: none; border: 1px solid #333; }
        
        button {
            background: #a855f7; color: white; border: none; padding: 15px;
            width: 100%; border-radius: 8px; font-size: 16px; font-weight: bold;
            margin-top: 20px; cursor: pointer;
        }
        button:disabled { background: #64748b; cursor: wait; opacity: 0.7; }

        /* Logs */
        .status-log {
            margin-top: 15px; font-family: monospace; font-size: 12px; 
            color: #fbbf24; background: black; padding: 10px; 
            border-radius: 6px; display: none; text-align: left;
        }

        .badge { background: #a855f7; font-size: 10px; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>HAKIMI PRO CLOUD</h1>
    <p>Powered by Real-ESRGAN (Generative AI)</p>

    <div class="api-box">
        <label>üîë Enter Replicate API Token (Required for Cloud GPU)</label>
        <input type="password" id="apiKey" placeholder="r8_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
        <div style="font-size:10px; color:#94a3b8; margin-top:5px;">
            Get free token at <a href="https://replicate.com/account/api-tokens" target="_blank" style="color:#a855f7">replicate.com</a>
        </div>
    </div>

    <div class="upload-box" onclick="document.getElementById('fileIn').click()">
        <span style="font-size:30px">‚òÅÔ∏è</span><br>Tap to Select Image
        <input type="file" id="fileIn" hidden accept="image/*">
    </div>

    <img id="preview" alt="Preview">

    <div id="controls" style="display:none;">
        <div class="status-log" id="logs"></div>
        <button onclick="startCloudUpscale()" id="btnProc">‚ú® START CLOUD UPSCALE (8X)</button>
    </div>

    <div id="resultArea" style="display:none; margin-top:30px; border-top:1px solid #333; padding-top:20px;">
        <h3 style="color:#10b981">‚úÖ Extraordinary Result</h3>
        <p style="font-size:12px; color:#aaa;">Generated by Cloud GPU</p>
        <img id="finalImg" style="border:2px solid #10b981;">
        <button onclick="downloadResult()" style="background:#10b981;">‚¨áÔ∏è DOWNLOAD HD</button>
    </div>
</div>

<script>
    // Config: We use a CORS Proxy because calling Replicate directly from browser is usually blocked.
    // In a real app, you would use your own backend. For this demo, we try direct.
    // IF THIS FAILS: You need a CORS extension or a proxy.
    
    let currentFile;

    function log(msg) {
        const l = document.getElementById('logs');
        l.style.display = 'block';
        l.innerHTML += `> ${msg}<br>`;
        l.scrollTop = l.scrollHeight;
    }

    document.getElementById('fileIn').addEventListener('change', (e) => {
        if(e.target.files[0]) {
            currentFile = e.target.files[0];
            document.getElementById('preview').src = URL.createObjectURL(currentFile);
            document.getElementById('preview').style.display = 'block';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('logs').innerHTML = "Ready to connect to Cloud...";
        }
    });

    async function startCloudUpscale() {
        const token = document.getElementById('apiKey').value.trim();
        if(!token) { alert("Please enter your Replicate API Token first."); return; }

        const btn = document.getElementById('btnProc');
        btn.disabled = true;
        log("1. Converting Image...");

        try {
            // 1. Convert Image to Base64
            const base64Img = await toBase64(currentFile);
            
            log("2. Sending to Cloud GPU...");
            log("   (Model: Real-ESRGAN/nightmareai)");

            // 2. Start Prediction
            // Note: We use a proxy here to bypass CORS if needed, or hit direct if allowed.
            // Replicate strictly blocks browser calls. We must use a proxy.
            // For this code to work, we will simulate the request or use a public proxy if available.
            // Since I cannot provide a backend for you, I will use the standard Replicate endpoint
            // and you might need a CORS Unblock extension on your phone/browser for this specific test.
            
            const response = await fetch("https://api.replicate.com/v1/predictions", {
                method: "POST",
                headers: {
                    "Authorization": `Token ${token}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    version: "42fed1c4974146d4d2414e2be2c5277c7fcf05fcc3a73abf41610695738c1d7b", // Real-ESRGAN
                    input: {
                        image: base64Img,
                        scale: 8,
                        face_enhance: true // This is the magic "Artguru" feature
                    }
                })
            });

            if(!response.ok) {
                // Common error: CORS
                throw new Error("Connection Blocked. Replicate does not allow direct browser access. You need a backend server.");
            }

            const data = await response.json();
            const predictionId = data.id;
            const getUrl = data.urls.get;

            log("3. Processing on Server (Wait ~10s)...");

            // 3. Poll for result
            let resultUrl = null;
            while(!resultUrl) {
                await new Promise(r => setTimeout(r, 2000)); // Wait 2s
                const poll = await fetch(getUrl, {
                    headers: { "Authorization": `Token ${token}` }
                });
                const statusData = await poll.json();
                
                if(statusData.status === "succeeded") {
                    resultUrl = statusData.output;
                    log("‚úÖ Success!");
                } else if (statusData.status === "failed") {
                    throw new Error("Cloud Error: " + statusData.error);
                } else {
                    log(`   Status: ${statusData.status}...`);
                }
            }

            // 4. Show Result
            document.getElementById('finalImg').src = resultUrl;
            document.getElementById('finalImg').style.display = 'block';
            document.getElementById('resultArea').style.display = 'block';
            btn.disabled = false;
            btn.innerText = "‚ú® GENERATE AGAIN";

        } catch (err) {
            console.error(err);
            if(err.message.includes("Connection Blocked") || err.message.includes("Failed to fetch")) {
                log("‚ùå BLOCKED: Browsers block direct API calls.");
                log("üí° FIX: Use a CORS Extension or run this on a server.");
                alert("Browser Security Error: To use this Pro API directly from a file, you must install a 'CORS Unblock' extension, or this code needs a backend server.");
            } else {
                log("‚ùå Error: " + err.message);
                alert(err.message);
            }
            btn.disabled = false;
        }
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    function downloadResult() {
        const link = document.createElement('a');
        link.href = document.getElementById('finalImg').src;
        link.download = "Hakimi_Cloud_Masterpiece.png";
        link.click();
    }
</script>

</body>
</html>
